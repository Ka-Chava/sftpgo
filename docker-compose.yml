version: '3.9'

# Droplet deployment for SFTPGo.
# Requires a .env file at repo root with: POSTGRES_PASSWORD=<strong-password>
# Run: docker compose up -d
# To redeploy after a push: docker compose up -d --build

services:
  sftpgo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sftpgo
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"  # localhost-only; Caddy proxies externally (not public)
      - "2022:2022"             # SFTP — public
    environment:
      # HTTP port (web admin + REST API)
      SFTPGO_HTTPD__BINDINGS__0__PORT: "8080"
      # Reverse proxy (Caddy → Cloudflare) — CSRF-safe
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__ENABLED: "true"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__HTTPS_PROXY_HEADERS__0__KEY: "X-Forwarded-Proto"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__HTTPS_PROXY_HEADERS__0__VALUE: "https"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__HOSTS_PROXY_HEADERS__0: "X-Forwarded-Host"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__ALLOWED_HOSTS__0: "sftp.kachava.com"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__ALLOWED_HOSTS__1: "sftpgo.kachava.com"
      SFTPGO_HTTPD__BINDINGS__0__BASE_URL: "https://sftp.kachava.com"
      SFTPGO_HTTPD__BINDINGS__0__SECURITY__HTTPS_REDIRECT: "false"
      # Client IP header from Cloudflare (passed through by Caddy)
      SFTPGO_HTTPD__BINDINGS__0__CLIENT_IP_PROXY_HEADER: "CF-Connecting-IP"
      SFTPGO_HTTPD__BINDINGS__0__CLIENT_IP_HEADER_DEPTH: "0"
      # Port 8080 is not publicly exposed — only Caddy (same Docker network) can reach it
      SFTPGO_HTTPD__BINDINGS__0__PROXY_ALLOWED__0: "0.0.0.0/0"
      # PostgreSQL data provider (local sidecar container)
      SFTPGO_DATA_PROVIDER__DRIVER: "postgresql"
      SFTPGO_DATA_PROVIDER__CONNECTION_STRING: "host=postgres port=5432 dbname=sftpgo user=sftpgo password=${POSTGRES_PASSWORD} sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - sftpgo_data:/srv/sftpgo
    networks:
      - sftpgo_net

  caddy:
    image: caddy:2-alpine
    container_name: sftpgo_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"     # HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data          # TLS certs auto-obtained + renewed via ACME
      - caddy_config:/config
    networks:
      - sftpgo_net

  postgres:
    image: postgres:15-alpine
    container_name: sftpgo_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: sftpgo
      POSTGRES_USER: sftpgo
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sftpgo_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sftpgo"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

volumes:
  sftpgo_data:
  postgres_data:
  caddy_data:
  caddy_config:

networks:
  sftpgo_net:
    driver: bridge
